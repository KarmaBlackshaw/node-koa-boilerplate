// store
const knex = require('@config/knex')

// libs
const _get = require('lodash/get')
const _first = require('lodash/first')

const { createFindArguments } = require('@utilities/knex-helper')

module.exports = {
  async list ({
    filter_by: filterBy,
    q,
    page,
    rows,
    sort_by: sortBy,
    sort,
    is_count: isCount,
    date_by: dateBy,
    date_from: dateFrom,
    date_to: dateTo,
    is_find: isFind
  } = {}) {
    const filterDictionary = {}

    const sortDictionary = {}

    const dateDictionary = {}

    try {
      const list = await knex('{{ pluralSnakeCase name }}')
        .meta({
          ...{ filterBy, q, filterDictionary },
          ...{ sortBy, sort, sortDictionary },
          ...{ dateBy, dateFrom, dateTo, dateDictionary },
          ...{ page, rows },
          isCount
        })
        .modify(function () {
          if (isFind) {
            this.limit(1)
          }

          if (isCount) {
            this
              .count({ total: '{{ pluralSnakeCase name }}.id' })
              .first()
          } else {
            this.select({
              id: '{{ pluralSnakeCase name }}.id',
              login_id: '{{ pluralSnakeCase name }}.login_id',
              login_name: '{{ pluralSnakeCase name }}.login_name',
              amount: '{{ pluralSnakeCase name }}.amount',
              created_at: '{{ pluralSnakeCase name }}.created_at'
            })
          }
        })

      if (isCount) {
        return _get(list, 'total', 0)
      }

      return list
    } catch (error) {
      console.log(error)
      throw error
    }
  },

  async find (conditions) {
    try {
      const data = await this.list({
        ...createFindArguments(conditions),
        is_find: true
      })

      return _first(data)
    } catch (error) {
      console.log(error)
      throw error
    }
  },

  async store (payload) {
    const fillables = [
      'foo',
      'bar'
    ]

    try {
      const [id] = await knex('{{ pluralSnakeCase name }}')
        .metaInsert(payload, fillables)

      return id
    } catch (error) {
      console.log(error)
      throw error
    }
  },

  async modify (id, payload) {
    try {
      const dictionary = {
        foo: '{{ pluralSnakeCase name }}.foo'
      }

      await knex({ tbl: '{{ pluralSnakeCase name }}' })
        .where('tbl.id', id)
        .metaUpdate(payload, dictionary)
    } catch (error) {
      console.log(error)
      throw error
    }
  }
}
